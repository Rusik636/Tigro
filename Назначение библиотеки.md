
# üêØ Tigro¬†‚Äî –∫–∞–∫ –≤—Å—Ç—Ä–æ–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≤¬†–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—É—é —ç–∫–æ—Å–∏—Å—Ç–µ–º—É Telegram‚Äë–±–æ—Ç–∞

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ Tigro**, –æ–±—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∞¬†—Ç–∞–∫–∂–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è **gateway‚Äëbot** –∏¬†–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞¬†`user_service`.

---

## –ó–∞—á–µ–º –Ω—É–∂–µ–Ω Tigro

| –ë–∞–∑–æ–≤—ã–π –±–æ—Ç | –ë–æ—Ç —Å Tigro |
|-------------|-------------|
| –ú–æ–Ω–æ–ª–∏—Ç –≤–ª–∞–¥–µ–µ—Ç Telegram¬†SDK –∏ –≤—Å–µ–π –±–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–æ–π | Telegram¬†SDK –∂–∏–≤—ë—Ç **—Ç–æ–ª—å–∫–æ** –≤ gateway‚Äëbot; –±–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∞ —Ä–∞–∑–º–∞–∑–∞–Ω–∞ –ø–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º, –≥–¥–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –ø–∏—à—É—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ –≤¬†aiogram |
| –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ | –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ |
| –õ—é–±–æ–µ –ø–∞–¥–µ–Ω–∏–µ –≤–∞–ª–∏—Ç –≤–µ—Å—å –±–æ—Ç | –°–±–æ–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –æ–¥–Ω–∏–º —Å–µ—Ä–≤–∏—Å–æ–º |

---

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```mermaid
sequenceDiagram
  participant TG as Telegram
  participant GW as gateway_bot (aiogram)
  participant MQ as RabbitMQ
  participant US as user_service (Tigro)

  TG->>GW: Update (/start)
  GW->>MQ: event.user.input (TgEvent)
  MQ->>US: TgEvent
  US->>US: Tigro Router ‚Üí @command("/start")
  US->>MQ: event.user.response.{user_id} (TgResponse)
  MQ->>GW: TgResponse
  GW->>TG: sendMessage("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ‚Ä¶")
```

### DTO-—à–∞–±–ª–æ–Ω—ã

| `TgEvent` –ø–æ–ª–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------------|-----------|
| `user_id`, `chat_id`, `message_id` | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã |
| `text`, `callback_data` | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–∏ |
| `state`, `event_type` | FSM‚Äë—Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Ç–∏–ø (`message` \| `callback`) |

| `TgResponse` –ø–æ–ª–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------------------|-----------|
| `action` | `send_message` \| `edit_message` \| ... |
| `text`, `markup` | –¢–µ–∫—Å—Ç –∏ –∏–Ω–ª–∞–π–Ω‚Äë–∫–Ω–æ–ø–∫–∏ |
| `next_state` | –ö—É–¥–∞ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ FSM |
| `metadata` | –°–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è (id —Å–æ–æ–±—â–µ–Ω–∏—è, callback_id) |

---

## –ü—Ä–∏–º–µ—Ä `gateway_bot/main.py`

```python
from aiogram import Bot, Dispatcher
from aiogram.types import Message
from aiogram.fsm.storage.memory import MemoryStorage
from faststream.rabbit import RabbitBroker
from gateway.message_router import MessageRouter  # –≤–∞—à –¥–µ–ª–µ–≥–∞—Ç–æ—Ä

API_TOKEN = "TG_TOKEN"
bot = Bot(API_TOKEN)
dp = Dispatcher(storage=MemoryStorage())
broker = RabbitBroker("amqp://guest:guest@rabbitmq/")

router = MessageRouter(bus=broker)   # FastStreamBus –≤–Ω—É—Ç—Ä–∏

@dp.message()
async def delegate(message: Message, state):
    await router(message, state, bot)

async def startup():
    await broker.connect(); await broker.declare()
    await dp.start_polling(bot)
```

---

## –ü—Ä–∏–º–µ—Ä `user_service/main.py`¬†(–∏—Å–ø–æ–ª—å–∑—É–µ–º Tigro)

```python
from fastapi import FastAPI
from faststream.rabbit import RabbitBroker
from shared.schemas import TgEvent
from tigro import Router, command, message
from tigro.transport import RabbitPublisher

broker = RabbitBroker("amqp://guest:guest@rabbitmq/")
router = Router(publisher=RabbitPublisher(broker))

@command("/start")
async def start(ctx):
    await ctx.send_message(
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
        next_state="await_email"
    )

@message(lambda ev: ev.text and "@" in ev.text)
async def got_email(ctx):
    await ctx.send_message(
        "–ù–∞ –ø–æ—á—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ.",
        next_state="await_code"
    )

for obj in list(globals().values()):
    if callable(obj) and hasattr(obj, "__matcher__"):
        router.register(obj.__matcher__, obj)

app = FastAPI()

@broker.subscriber("event.user.input")
async def on_event(payload: dict):
    await router.dispatch(TgEvent(**payload))

@app.on_event("startup")
async def startup():
    await broker.connect(); await broker.declare()
```

---

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö —à–∞–≥¬†–∑–∞¬†—à–∞–≥–æ–º

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –ø–∏—à–µ—Ç `/start`  
2. **gateway_bot** —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ `TgEvent` –∏ –∫–ª–∞–¥—ë—Ç –≤ RabbitMQ  
3. **user_service** –ø–æ–ª—É—á–∞–µ—Ç `TgEvent`,¬†Tigro –Ω–∞—Ö–æ–¥–∏—Ç `@command("/start")`, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç `TgResponse` —á–µ—Ä–µ–∑ `ctx.send_message()`  
4. Tigro –ø—É–±–ª–∏–∫—É–µ—Ç `TgResponse` –≤ `event.user.response.{user_id}`  
5. **gateway_bot** –∏—Å–ø–æ–ª–Ω—è–µ—Ç API‚Äë–º–µ—Ç–æ–¥ `sendMessage` –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –º–µ–Ω—è–µ—Ç FSM‚Äë—Å–æ—Å—Ç–æ—è–Ω–∏–µ

---

## –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫‚Äë–ª–∏—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

1. `broker = RabbitBroker(...)`
2. `router = Router(publisher=RabbitPublisher(broker))`
3. –ü–∏—à–µ–º —Ö–µ–Ω–¥–ª–µ—Ä—ã —Å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏ `@command | @message | @callback`
4. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏—Ö –≤ Router
5. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ `event.user.input`
6. –í—ã–∑—ã–≤–∞–µ–º `await router.dispatch(TgEvent(**raw))`

---

–ì–æ—Ç–æ–≤–æ! –°–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Telegram‚Äë—Å–æ–±—ã—Ç–∏—è, –Ω–µ –∑–Ω–∞—è –æ Telegram¬†API.
